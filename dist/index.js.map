{"version":3,"file":"index.js","sources":["../schema.js","../index.js"],"sourcesContent":["// JSON schema used to validate tags options.\nconst tagsSchema = {\n  type: 'object',\n  patternProperties: {\n    '.*': {\n      type: 'object',\n      patternProperties: {\n        '.*': {\n          type: 'array',\n          items: {\n            type: 'object',\n            patternProperties: {\n              '.*': {\n                type: 'string',\n              },\n            },\n          },\n        },\n      },\n    },\n  },\n};\n\nexport default {\n  type: 'object',\n  properties: {\n    pages: {\n      type: 'array',\n      items: {\n        type: 'string',\n        pattern: '\\.html$', // eslint-disable-line no-useless-escape\n      },\n    },\n    tags: tagsSchema,\n  },\n  required: ['tags'],\n};\n","import HtmlWebpackPlugin from 'html-webpack-plugin';\nimport cheerio from 'cheerio';\nimport createElement from 'create-html-element';\nimport optionsSchema from './schema';\nimport validateOptions from 'schema-utils';\n\nconst getTagString = (name, attr = {}) => {\n  const attributes = Object.assign({}, attr);\n  const html = attributes.html || '';\n  delete attributes.html;\n  try {\n    return createElement({ name, attributes, html });\n  } catch (e) {\n    throw new Error(`Metatagger Plugin: Error creating '${name}' element with attributes: \\n${JSON.stringify(attributes, null, 2)}`);\n  }\n};\n\nexport default class MetataggerPlugin {\n  constructor(options) {\n    validateOptions(optionsSchema, options, 'MetataggerPlugin');\n\n    this.options = options;\n  }\n\n  addMetatag = (selector, tag, attributes, prepend = false) => {\n    const parent = this.$(selector);\n\n    if (parent.length === 0) {\n      throw new Error(`Metatagger Plugin: Can't locate any elements with '${selector}' selector.`);\n    }\n\n    if (parent.length > 1) {\n      console.warn(`Metatagger Plugin: More than one element foound with '${selector}' selector.`);\n    }\n\n    if (prepend) {\n      parent.prepend(getTagString(tag, attributes));\n    } else {\n      parent.append(getTagString(tag, attributes));\n    }\n  };\n\n  apply(compiler) {\n    const { tags, pages } = this.options;\n\n    if (!tags) return;\n\n    compiler.hooks.compilation.tap('MetataggerPlugin', (compilation) => {\n      HtmlWebpackPlugin.getHooks(compilation).beforeEmit.tapAsync(\n        'MetataggerPlugin',\n        (data, cb) => {\n          const emittedPageName = data.plugin.childCompilationOutputName || data.outputName;\n\n          if (pages && pages.indexOf(emittedPageName) < 0) return cb(null, data);\n\n          try {\n            this.$ = cheerio.load(data.html);\n          } catch (e) {\n            throw new Error('Metatagger Plugin: Error loading HTML:\\n' + e);\n          }\n\n          Object.keys(tags).forEach((selector) => {\n            const prepend = /__prepend$/.test(selector);\n            const tagTypes = tags[selector];\n\n            selector = selector.replace(/__prepend$/, '');\n            Object.keys(tagTypes).forEach((tag) => {\n              tagTypes[tag].forEach((attrs) => {\n                this.addMetatag(selector, tag, attrs, prepend);\n              });\n            });\n          });\n\n          try {\n            data.html = this.$.html();\n          } catch (e) {\n            throw new Error('Metatagger Plugin: Error rendering HTML:\\n' + e);\n          }\n          cb(null, data);\n        }\n      );\n    });\n  }\n};\n"],"names":["const","tagsSchema","type","patternProperties","items","properties","pages","pattern","tags","required","getTagString","name","attr","attributes","Object","assign","html","createElement","e","Error","JSON","stringify","MetataggerPlugin","constructor","options","addMetatag","selector","tag","prepend","parent","this","$","length","console","warn","append","validateOptions","optionsSchema","apply","compiler","hooks","compilation","tap","HtmlWebpackPlugin","getHooks","beforeEmit","tapAsync","data","cb","emittedPageName","plugin","childCompilationOutputName","outputName","indexOf","cheerio","load","keys","forEach","test","tagTypes","replace","attrs"],"mappings":"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"}